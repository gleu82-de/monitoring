name: Deploy to PROD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: [self-hosted, dgl-global]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy to local filesystem
        run: |
          DEPLOY_DIR="/home/dgl/monitoring"
          SYMLINK="/root/monitoring"
          
          echo "=== Deploying to $DEPLOY_DIR ==="
          
          # Create directory structure
          mkdir -p $DEPLOY_DIR/{scripts,config,bin,docs}
          
          # Deploy files
          cp -r scripts/*.sh $DEPLOY_DIR/scripts/
          chmod +x $DEPLOY_DIR/scripts/*.sh
          
          cp -r config/* $DEPLOY_DIR/config/
          cp -r bin/* $DEPLOY_DIR/bin/
          chmod +x $DEPLOY_DIR/bin/*.sh
          
          cp -r docs/* $DEPLOY_DIR/docs/ 2>/dev/null || true
          cp VERSION $DEPLOY_DIR/
          cp README.md $DEPLOY_DIR/
          
          # Create root symlink
          sudo ln -sfn $DEPLOY_DIR $SYMLINK
          
          echo "✅ Deployment complete"
          
      - name: Verify Deployment
        run: |
          DEPLOYED_VERSION=$(cat /home/dgl/monitoring/VERSION)
          EXPECTED_VERSION=$(cat VERSION)
          
          if [ "$DEPLOYED_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "✅ Version verified: $DEPLOYED_VERSION"
          else
            echo "❌ Version mismatch: expected $EXPECTED_VERSION, got $DEPLOYED_VERSION"
            exit 1
          fi
